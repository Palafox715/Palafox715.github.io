<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard IT</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg p-6 space-y-4">
    <h1 class="text-2xl font-semibold">Tickets de soporte</h1>

    <!-- Alerta sticky (cola) -->
    <div id="new-ticket-alert" class="hidden relative p-4 pl-12 rounded-md border-2 border-red-600 bg-red-50 text-red-800">
      <div class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-red-600 text-white flex items-center justify-center shadow-md">!</div>
      <div class="font-semibold">Nuevo ticket recibido</div>
      <div class="text-sm" id="alert-text"></div>
      <button id="alert-close" class="absolute right-3 top-3 text-red-700 hover:text-red-900 text-sm">Cerrar</button>
    </div>

    {% if message %}
      <div class="p-3 rounded flex items-center gap-2
        {{ 'bg-green-100 border border-green-400 text-green-700' if category=='success'
           else 'bg-red-100 border border-red-400 text-red-700' }}">
        <span>{{ message }}</span>
      </div>
    {% endif %}

    <!-- Barra superior: filtros + acciones -->
    <div class="grid gap-3 lg:grid-cols-[1fr_auto_auto] items-end">
      <!-- Filtros -->
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label for="statusFilter" class="block text-sm text-gray-700">Estado</label>
          <select id="statusFilter" class="border rounded-md h-10 px-3 w-40">
            <option value="todos"       {{ 'selected' if selected_status=='todos' }}>Todos</option>
            <option value="pendiente"   {{ 'selected' if selected_status=='pendiente' }}>Pendiente</option>
            <option value="en progreso" {{ 'selected' if selected_status=='en progreso' }}>En progreso</option>
            <option value="resuelto"    {{ 'selected' if selected_status=='resuelto' }}>Resuelto</option>
          </select>
        </div>

        <div>
          <label for="techFilter" class="block text-sm text-gray-700">Técnico</label>
          <select id="techFilter" class="border rounded-md h-10 px-3 w-40">
            <option value="todos" {{ 'selected' if selected_tech=='todos' }}>Todos</option>
            {% for t in tecnicos %}
              <option value="{{ t }}" {{ 'selected' if selected_tech==t }}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Acciones -->
      <div class="flex items-end gap-2 justify-start lg:justify-center">
        <a id="exportBtn" href="{{ url_for('export_tickets') }}"
           class="bg-yellow-500 text-white px-4 h-10 rounded-md hover:bg-yellow-600 flex items-center">
          Exportar CSV
        </a>
        <a href="{{ url_for('admin_settings') }}"
           class="bg-slate-600 text-white px-4 h-10 rounded-md hover:bg-slate-700 flex items-center">
          Ajustes
        </a>
      </div>

      <!-- Borrar seleccionados (seguro) -->
      <form id="delete-selected-form"
            class="flex flex-wrap lg:flex-nowrap items-end gap-2 justify-start lg:justify-end">
        <input type="password" name="password" placeholder="Clave"
               class="border rounded-md h-10 px-3 w-44" required>
        <input type="text" name="confirm" placeholder="Escribe ELIMINAR"
               class="border rounded-md h-10 px-3 w-48" required>
        <button id="delete-selected-btn" type="submit"
                class="bg-red-700 text-white px-4 h-10 rounded-md hover:bg-red-800 disabled:opacity-50"
                disabled>Borrar seleccionados</button>
      </form>
    </div>

    <!-- Contador selección -->
    <div class="text-sm text-gray-600">Seleccionados: <span id="sel-count">0</span></div>

    <!-- Tabla -->
    <div class="relative overflow-auto max-h-[70vh]">
      <table class="min-w-full table-fixed text-sm">
        <thead class="sticky top-0 z-10 bg-gray-200">
          <tr>
            <th class="px-3 py-2 text-center w-12">
              <input id="check-all" type="checkbox" class="h-4 w-4">
            </th>
            <th class="px-3 py-2 text-left w-16">ID</th>
            <th class="px-3 py-2 text-left w-28">Cubículo</th>
            <th class="px-3 py-2 text-left w-[26rem]">Problema</th>
            <th class="px-3 py-2 text-left w-28">Status</th>
            <th class="px-3 py-2 text-left w-40 whitespace-nowrap">Hora</th>
            <th class="px-3 py-2 text-center w-36 whitespace-nowrap">Atendido por</th>
            <th class="px-3 py-2 text-left w-64">Acciones</th>
            <!-- NUEVA COLUMNA justo antes de Editar -->
            <th class="px-3 py-2 text-left w-60">Observaciones</th>
            <th class="px-3 py-2 text-center w-14">Editar</th>
          </tr>
        </thead>
        <tbody id="tickets-body" data-max-id="{{ tickets[0].id if tickets|length else 0 }}">
          {% include "_tickets_tbody.html" %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal Editar -->
  <div id="edit-modal" class="fixed inset-0 hidden bg-black/40 backdrop-blur-sm z-50">
    <div class="bg-white w-[36rem] max-w-[95vw] mx-auto mt-24 rounded-lg shadow-xl p-5">
      <h2 class="text-lg font-semibold mb-3">Editar ticket</h2>
      <form id="edit-form" method="post" action="#">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-gray-700 mb-1">Cubículo</label>
            <select id="edit-cubiculo" name="cubiculo" class="w-full border rounded-md h-10 px-2" required>
              <option value="" disabled>Elige cubículo</option>
              {% for c in cubiculos %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Problema</label>
            <select id="edit-problema" name="problema" class="w-full border rounded-md h-10 px-2" required>
              <option value="" disabled>Elige problema</option>
              {% for p in problemas %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Estatus</label>
            <select id="edit-status" name="status" class="w-full border rounded-md h-10 px-2" required>
              <option value="pendiente">pendiente</option>
              <option value="en progreso">en progreso</option>
              <option value="resuelto">resuelto</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Hora</label>
            <input id="edit-hora" name="hora" type="datetime-local"
                   class="w-full border rounded-md h-10 px-2">
          </div>
        </div>

        <div id="resolved-fields" class="mt-3 grid grid-cols-2 gap-3 hidden">
          <div>
            <label class="block text-sm text-gray-700 mb-1">Técnico</label>
            <select id="edit-tecnico" name="atendido_por" class="w-full border rounded-md h-10 px-2">
              <option value="">—</option>
              {% for t in tecnicos %}<option value="{{ t }}">{{ t }}</option>{% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-700 mb-1">Solución</label>
            <input id="edit-solucion" name="solucion" type="text"
                   class="w-full border rounded-md h-10 px-2" placeholder="Descripción breve">
          </div>
        </div>

        <!-- Observaciones: siempre visible -->
        <div class="mt-3">
          <label class="block text-sm text-gray-700 mb-1">Observaciones</label>
          <textarea id="edit-observaciones" name="observaciones" rows="3"
                    class="w-full border rounded-md p-2"
                    placeholder="Notas adicionales, seguimiento, material faltante…"></textarea>
        </div>

        <div class="mt-5 flex justify-end gap-2">
          <button type="button" id="edit-cancel"
                  class="bg-gray-200 text-gray-800 px-4 h-10 rounded-md hover:bg-gray-300">Cancelar</button>
          <button type="submit"
                  class="bg-blue-600 text-white px-4 h-10 rounded-md hover:bg-blue-700">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    #new-ticket-alert { box-shadow: 0 0 0 3px rgba(220,38,38,0.2), 0 10px 20px rgba(0,0,0,.08); }
    .alert-pop { animation: alertPulse 1.2s ease-in-out infinite; }
    @keyframes alertPulse { 0%{transform:scale(1)} 50%{transform:scale(1.015)} 100%{transform:scale(1)} }
    .row-selected { background-color: #FEF9C3; }
  </style>

  <script>
    const bodyEl   = document.getElementById('tickets-body');
    const statusEl = document.getElementById('statusFilter');
    const techEl   = document.getElementById('techFilter');
    const checkAll = document.getElementById('check-all');

    // --- ALERTA + COLA ---
    const alertEl  = document.getElementById('new-ticket-alert');
    const alertTxt = document.getElementById('alert-text');
    const alertCloseBtn = document.getElementById('alert-close');

    const LS_LAST_SEEN = 'lastSeenId';
    const LS_QUEUE     = 'ticketAlertQueue';
    const LS_SELECTED  = 'selectedIds';

    let modalOpen = false; // pausa el refresh cuando el modal está abierto

    function getLastSeen() {
      return parseInt(localStorage.getItem(LS_LAST_SEEN) || (bodyEl.getAttribute('data-max-id') || 0), 10);
    }
    function setLastSeen(v) { localStorage.setItem(LS_LAST_SEEN, String(v || 0)); }

    function getQueue() { try { return JSON.parse(localStorage.getItem(LS_QUEUE) || '[]'); } catch { return []; } }
    function setQueue(q){ localStorage.setItem(LS_QUEUE, JSON.stringify(q || [])); }
    function enqueueNews(news){
      if (!Array.isArray(news)) return;
      const q = getQueue(); const ids = new Set(q.map(x=>x.id));
      for (const n of news) if (!ids.has(n.id)) { q.push(n); ids.add(n.id); }
      setQueue(q);
    }
    function currentAlert(){ const q = getQueue(); return q[0] || null; }
    function popCurrentAlert(){ const q = getQueue(); const r=q.shift(); setQueue(q); return r||null; }
    function removeFromQueueById(id){ setQueue(getQueue().filter(x=>x.id!==id)); }
    function showCurrentAlert(){
      const cur=currentAlert();
      if (!cur) { hideAlert(); return; }
      alertTxt.textContent = `Cubículo ${cur.cubiculo} — ${cur.problema} (${cur.hora})`;
      alertEl.classList.remove('hidden'); alertEl.classList.add('alert-pop');
    }
    function hideAlert(){ alertEl.classList.add('hidden'); alertEl.classList.remove('alert-pop'); }
    alertCloseBtn.addEventListener('click', ()=>{ popCurrentAlert(); showCurrentAlert(); });

    // --- SELECCIÓN ---
    function getSelected(){ try { return new Set(JSON.parse(localStorage.getItem(LS_SELECTED) || '[]')); } catch { return new Set(); } }
    function saveSelected(set){ localStorage.setItem(LS_SELECTED, JSON.stringify([...set])); }
    const selected = getSelected();

    function updateSelUI(){
      document.getElementById('sel-count').textContent = selected.size;
      document.getElementById('delete-selected-btn').disabled = selected.size === 0;
      bodyEl.querySelectorAll('tr').forEach(tr => tr.classList.remove('row-selected'));
      bodyEl.querySelectorAll('.row-check').forEach(cb => {
        const id = parseInt(cb.dataset.id,10);
        cb.checked = selected.has(id);
        if (cb.checked) cb.closest('tr')?.classList.add('row-selected');
      });
      const boxes = [...bodyEl.querySelectorAll('.row-check')];
      checkAll.checked = boxes.length>0 && boxes.every(cb => cb.checked);
      checkAll.indeterminate = boxes.some(cb => cb.checked) && !checkAll.checked;
    }

    function wireRowCheckboxes(){
      bodyEl.querySelectorAll('.row-check').forEach(cb => {
        const id = parseInt(cb.dataset.id,10);
        cb.checked = selected.has(id);
        if (cb.checked) cb.closest('tr')?.classList.add('row-selected');
        cb.addEventListener('change', () => {
          if (cb.checked) { selected.add(id); cb.closest('tr')?.classList.add('row-selected'); }
          else { selected.delete(id); cb.closest('tr')?.classList.remove('row-selected'); }
          saveSelected(selected); updateSelUI();
        });
      });
    }

    checkAll.addEventListener('change', ()=>{
      const boxes = bodyEl.querySelectorAll('.row-check');
      boxes.forEach(cb => {
        const id = parseInt(cb.dataset.id,10);
        cb.checked = checkAll.checked;
        if (checkAll.checked) { selected.add(id); cb.closest('tr')?.classList.add('row-selected'); }
        else { selected.delete(id); cb.closest('tr')?.classList.remove('row-selected'); }
      });
      saveSelected(selected); updateSelUI();
    });

    // Interceptar "Atendiendo": oculta alerta de ese ticket y no toca selección
    document.addEventListener('click', (e) => {
      const a = e.target.closest('[data-action="attend"]');
      if (!a) return;
      let id = a.dataset.ticketId ? parseInt(a.dataset.ticketId,10) : null;
      if (!id) { const m = a.getAttribute('href')?.match(/\/process\/(\d+)/); if (m) id = parseInt(m[1], 10); }
      if (id) {
        const cur = currentAlert();
        if (cur && cur.id === id) hideAlert();
        removeFromQueueById(id);
      }
    });

    function beep(duration=180, frequency=920) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.type='square'; osc.frequency.value=frequency;
        osc.connect(gain); gain.connect(ctx.destination); gain.gain.value=0.05;
        osc.start(); setTimeout(()=>{osc.stop(); ctx.close();}, duration);
      } catch(e) {}
    }

    function snapshotInputs() {
      const snap = {};
      bodyEl.querySelectorAll('form[data-ticket-id]').forEach(form => {
        const id = form.getAttribute('data-ticket-id'); snap[id] = {};
        form.querySelectorAll('input, select, textarea').forEach(ctrl => { snap[id][ctrl.name] = ctrl.value; });
        const active = document.activeElement; if (active && form.contains(active)) snap[id]._focus = active.name || '';
      });
      return snap;
    }
    function restoreInputs(snap) {
      if (!snap) return;
      bodyEl.querySelectorAll('form[data-ticket-id]').forEach(form => {
        const id = form.getAttribute('data-ticket-id'); if (!snap[id]) return;
        form.querySelectorAll('input, select, textarea').forEach(ctrl => {
          if (snap[id][ctrl.name] !== undefined) ctrl.value = snap[id][ctrl.name];
        });
        if (snap[id]._focus) { const toFocus = form.querySelector(`[name="${snap[id]._focus}"]`); if (toFocus) toFocus.focus(); }
      });
    }

    // === Helpers de MODAL ===
    const editModal   = document.getElementById('edit-modal');
    const editForm    = document.getElementById('edit-form');
    const fCubiculo   = document.getElementById('edit-cubiculo');
    const fProblema   = document.getElementById('edit-problema');
    const fStatus     = document.getElementById('edit-status');
    const fTecnico    = document.getElementById('edit-tecnico');
    const fSolucion   = document.getElementById('edit-solucion');
    const fHora       = document.getElementById('edit-hora');
    const fObs        = document.getElementById('edit-observaciones');
    const resolvedBox = document.getElementById('resolved-fields');
    const btnCancel   = document.getElementById('edit-cancel');

    function setSelectValueCaseInsensitive(selectEl, value) {
      if (!selectEl) return;
      const target = (value || '').trim().toLowerCase();
      let matched = false;
      for (const opt of selectEl.options) {
        if (opt.value.trim().toLowerCase() === target) {
          opt.selected = true; matched = true; break;
        }
      }
      if (!matched) selectEl.selectedIndex = -1;
    }
    function dbToInput(dtStr) {
      if (!dtStr) return '';
      return dtStr.replace(' ', 'T').slice(0,16);
    }
    function toggleResolvedFields() {
      const isResolved = fStatus.value === 'resuelto';
      resolvedBox.classList.toggle('hidden', !isResolved);
      fTecnico.required  = isResolved;
      fSolucion.required = isResolved;
      if (!isResolved) { fTecnico.value = ''; fSolucion.value = ''; }
    }
    function openEditModal(data) {
      modalOpen = true;
      editForm.action = `/ticket/${data.id}/edit`;

      setSelectValueCaseInsensitive(fCubiculo, data.cubiculo);
      setSelectValueCaseInsensitive(fProblema, data.problema);
      fStatus.value   = (data.status || 'pendiente');
      setSelectValueCaseInsensitive(fTecnico,  data.atendido);

      fSolucion.value = data.solucion || '';
      fHora.value     = dbToInput(data.hora || '');
      fObs.value      = data.observaciones || '';

      toggleResolvedFields();
      editModal.classList.remove('hidden');
    }
    function closeEditModal() {
      modalOpen = false;
      editModal.classList.add('hidden');
    }
    btnCancel.addEventListener('click', closeEditModal);
    fStatus.addEventListener('change', toggleResolvedFields);

    // Abrir modal al pulsar "Editar"
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-action="edit"]');
      if (!btn) return;
      const data = {
        id: parseInt(btn.dataset.id,10),
        cubiculo: btn.dataset.cubiculo || '',
        problema: btn.dataset.problema || '',
        status: btn.dataset.status || 'pendiente',
        atendido: btn.dataset.atendido || '',
        solucion: btn.dataset.solucion || '',
        hora: btn.dataset.hora || '',
        observaciones: btn.dataset.observaciones || ''
      };
      openEditModal(data);
    });

    // --- REFRESH (pausado si modal abierto) ---
    async function refreshTable() {
      if (modalOpen) return;
      const status = statusEl.value || 'todos';
      const tech   = techEl.value   || 'todos';
      const beforeSnap = snapshotInputs();
      const lastSeen = getLastSeen();

      try {
        const url = `/dashboard/table?status=${encodeURIComponent(status)}&tech=${encodeURIComponent(tech)}&since_id=${lastSeen}`;
        const res  = await fetch(url, { cache: 'no-store' });
        const data = await res.json();

        bodyEl.innerHTML = data.html;
        bodyEl.setAttribute('data-max-id', data.max_id); // <- correcto

        // limpiar selección de IDs que ya no están
        const present = new Set([...bodyEl.querySelectorAll('.row-check')].map(cb => parseInt(cb.dataset.id,10)));
        const selected = new Set(JSON.parse(localStorage.getItem(LS_SELECTED) || '[]'));
        [...selected].forEach(id => { if (!present.has(id)) selected.delete(id); });
        localStorage.setItem(LS_SELECTED, JSON.stringify([...selected]));

        wireRowCheckboxes();
        updateSelUI();

        if (Array.isArray(data.news) && data.news.length) {
          enqueueNews(data.news); beep(); showCurrentAlert();
        }
        if (typeof data.max_id === 'number') setLastSeen(Math.max(lastSeen, data.max_id));

        restoreInputs(beforeSnap);
      } catch (e) {
        console.warn('refresh error', e);
      }
    }

    function syncQueryString() {
      const u = new URL(window.location.href);
      u.searchParams.set('status', statusEl.value || 'todos');
      u.searchParams.set('tech', techEl.value || 'todos');
      window.history.replaceState({}, '', u);
    }
    statusEl.addEventListener('change', () => { syncQueryString(); refreshTable(); });
    techEl.addEventListener('change',   () => { syncQueryString(); refreshTable(); });

    // Borrar seleccionados (AJAX)
    document.getElementById('delete-selected-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const ids = JSON.parse(localStorage.getItem(LS_SELECTED) || '[]');
      if (!ids.length) return;

      const fd = new FormData(e.target);
      fd.append('ids', ids.join(','));

      const res = await fetch('{{ url_for("admin_delete_selected") }}', { method: 'POST', body: fd });
      const data = await res.json().catch(()=>({}));

      if (!res.ok || !data.ok) {
        alert(data.error || 'Error al borrar seleccionados');
        return;
      }
      // limpiar selección y refrescar
      localStorage.setItem(LS_SELECTED, JSON.stringify([]));
      updateSelUI();
      checkAll.checked = false;
      checkAll.indeterminate = false;
      refreshTable();
    });

    // Al cargar
    wireRowCheckboxes(); updateSelUI(); showCurrentAlert();
    setInterval(refreshTable, 5000);
  </script>
</body>
</html>
